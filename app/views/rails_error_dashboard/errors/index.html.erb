<div class="py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0"><i class="bi bi-bug-fill text-primary"></i> Error Overview</h2>
    <div class="text-muted">
      <small>Last updated: <%= Time.current.strftime("%B %d, %Y %I:%M %p") %></small>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row g-4 mb-4">
    <div class="col-md-3">
      <div class="card stat-card">
        <div class="card-body">
          <div class="stat-label mb-2">Today</div>
          <div class="stat-value text-info"><%= @stats[:total_today] %></div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stat-card">
        <div class="card-body">
          <div class="stat-label mb-2">This Week</div>
          <div class="stat-value text-primary"><%= @stats[:total_week] %></div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stat-card">
        <div class="card-body">
          <div class="stat-label mb-2">Unresolved</div>
          <div class="stat-value text-danger"><%= @stats[:unresolved] %></div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stat-card">
        <div class="card-body">
          <div class="stat-label mb-2">Resolved</div>
          <div class="stat-value text-success"><%= @stats[:resolved] %></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Platform & Environment Breakdown -->
  <div class="row g-4 mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0">Platform Breakdown</h5>
        </div>
        <div class="card-body">
          <% if @stats[:by_platform].any? %>
            <% @stats[:by_platform].each do |platform, count| %>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span>
                  <% if platform == 'iOS' %>
                    <span class="badge badge-ios">iOS</span>
                  <% elsif platform == 'Android' %>
                    <span class="badge badge-android">Android</span>
                  <% else %>
                    <span class="badge badge-api">API</span>
                  <% end %>
                </span>
                <span class="fw-bold"><%= count %></span>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted mb-0">No errors recorded yet</p>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0">Top Error Types</h5>
        </div>
        <div class="card-body">
          <% if @stats[:top_errors].any? %>
            <% @stats[:top_errors].first(5).each do |error_type, count| %>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="text-truncate" style="max-width: 70%;"><%= error_type %></small>
                <span class="badge bg-secondary"><%= count %></span>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted mb-0">No errors recorded yet</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-header bg-white">
      <h5 class="mb-0">Filters & Search</h5>
    </div>
    <div class="card-body">
      <%= form_with url: errors_path, method: :get, class: "row g-3" do %>
        <div class="col-md-3">
          <%= text_field_tag :search, params[:search], placeholder: "Search errors...", class: "form-control" %>
        </div>
        <div class="col-md-2">
          <%= select_tag :environment, options_for_select([['All Environments', '']] + @environments.map { |e| [e.titleize, e] }, params[:environment]), class: "form-select" %>
        </div>
        <div class="col-md-2">
          <%= select_tag :platform, options_for_select([['All Platforms', '']] + @platforms.map { |p| [p, p] }, params[:platform]), class: "form-select" %>
        </div>
        <div class="col-md-3">
          <%= select_tag :error_type, options_for_select([['All Types', '']] + @error_types.map { |t| [t, t] }, params[:error_type]), class: "form-select" %>
        </div>
        <div class="col-md-2">
          <div class="form-check">
            <%= check_box_tag :unresolved, true, params[:unresolved] == 'true', class: "form-check-input" %>
            <%= label_tag :unresolved, "Unresolved only", class: "form-check-label" %>
          </div>
        </div>
        <div class="col-12">
          <%= submit_tag "Apply Filters", class: "btn btn-primary" %>
          <%= link_to "Clear", errors_path, class: "btn btn-outline-secondary" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Error List Table -->
  <div class="card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Recent Errors</h5>
      <small class="text-muted"><%== pagy_info(@pagy) %></small>
    </div>

    <!-- Batch Actions Toolbar -->
    <div class="card-body border-bottom" id="batch-actions-toolbar" style="display: none;">
      <%= form_with url: batch_action_errors_path, method: :post, id: "batch-form" do |f| %>
        <div class="row align-items-center">
          <div class="col-auto">
            <span id="selected-count" class="fw-bold">0 selected</span>
          </div>
          <div class="col-auto">
            <%= button_tag type: "submit", name: "action_type", value: "resolve", class: "btn btn-sm btn-success" do %>
              <i class="bi bi-check-circle"></i> Resolve Selected
            <% end %>
          </div>
          <div class="col-auto">
            <%= button_tag type: "submit", name: "action_type", value: "delete", class: "btn btn-sm btn-danger", data: { confirm: "Are you sure you want to delete the selected errors?" } do %>
              <i class="bi bi-trash"></i> Delete Selected
            <% end %>
          </div>
          <div class="col-auto">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-selection">
              Clear Selection
            </button>
          </div>
        </div>
      <% end %>
    </div>

    <div class="card-body p-0">
      <% if @errors.any? %>
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th style="width: 40px;">
                  <input type="checkbox" id="select-all" class="form-check-input">
                </th>
                <th>Time</th>
                <th>Error Type</th>
                <th>Message</th>
                <th>Platform</th>
                <th>Environment</th>
                <th>User</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% @errors.each do |error| %>
                <tr>
                  <td onclick="event.stopPropagation();">
                    <input type="checkbox" class="error-checkbox form-check-input" value="<%= error.id %>" data-error-id="<%= error.id %>">
                  </td>
                  <td onclick="window.location='<%= error_path(error) %>';">
                    <small><%= error.occurred_at.strftime("%m/%d %I:%M%p") %></small>
                  </td>
                  <td onclick="window.location='<%= error_path(error) %>';">
                    <code class="text-danger"><%= error.error_type.split('::').last %></code>
                  </td>
                  <td onclick="window.location='<%= error_path(error) %>';">
                    <div class="text-truncate" style="max-width: 300px;" title="<%= error.message %>">
                      <%= error.message %>
                    </div>
                  </td>
                  <td onclick="window.location='<%= error_path(error) %>';">
                    <% if error.platform == 'iOS' %>
                      <span class="badge badge-ios">iOS</span>
                    <% elsif error.platform == 'Android' %>
                      <span class="badge badge-android">Android</span>
                    <% else %>
                      <span class="badge badge-api"><%= error.platform || 'API' %></span>
                    <% end %>
                  </td>
                  <td onclick="window.location='<%= error_path(error) %>';">
                    <span class="badge <%= error.environment == 'production' ? 'bg-danger' : 'bg-info' %>">
                      <%= error.environment %>
                    </span>
                  </td>
                  <td onclick="window.location='<%= error_path(error) %>';">
                    <% if error.user %>
                      <small><%= error.user.email %></small>
                    <% else %>
                      <small class="text-muted">Guest</small>
                    <% end %>
                  </td>
                  <td onclick="window.location='<%= error_path(error) %>';">
                    <% if error.resolved? %>
                      <i class="bi bi-check-circle-fill text-success" title="Resolved"></i>
                    <% else %>
                      <i class="bi bi-exclamation-circle-fill text-danger" title="Unresolved"></i>
                    <% end %>
                  </td>
                  <td onclick="event.stopPropagation();">
                    <%= link_to error_path(error), class: "btn btn-sm btn-outline-primary" do %>
                      <i class="bi bi-eye"></i>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="p-3">
          <%== pagy_bootstrap_nav(@pagy) if @pagy.pages > 1 %>
        </div>
      <% else %>
        <div class="text-center py-5">
          <i class="bi bi-inbox display-1 text-muted"></i>
          <p class="text-muted mt-3">No errors found</p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select-all');
    const errorCheckboxes = document.querySelectorAll('.error-checkbox');
    const batchToolbar = document.getElementById('batch-actions-toolbar');
    const selectedCountSpan = document.getElementById('selected-count');
    const batchForm = document.getElementById('batch-form');
    const clearSelectionBtn = document.getElementById('clear-selection');

    function updateBatchToolbar() {
      const checkedBoxes = document.querySelectorAll('.error-checkbox:checked');
      const count = checkedBoxes.length;

      if (count > 0) {
        batchToolbar.style.display = 'block';
        selectedCountSpan.textContent = `${count} selected`;
      } else {
        batchToolbar.style.display = 'none';
      }
    }

    // Select all checkbox
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', function() {
        errorCheckboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
        updateBatchToolbar();
      });
    }

    // Individual checkboxes
    errorCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        updateBatchToolbar();

        // Update "select all" checkbox state
        const allChecked = Array.from(errorCheckboxes).every(cb => cb.checked);
        const someChecked = Array.from(errorCheckboxes).some(cb => cb.checked);

        if (selectAllCheckbox) {
          selectAllCheckbox.checked = allChecked;
          selectAllCheckbox.indeterminate = someChecked && !allChecked;
        }
      });
    });

    // Clear selection button
    if (clearSelectionBtn) {
      clearSelectionBtn.addEventListener('click', function() {
        errorCheckboxes.forEach(checkbox => {
          checkbox.checked = false;
        });
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        }
        updateBatchToolbar();
      });
    }

    // Form submission - add selected error IDs
    if (batchForm) {
      batchForm.addEventListener('submit', function(e) {
        const checkedBoxes = document.querySelectorAll('.error-checkbox:checked');

        if (checkedBoxes.length === 0) {
          e.preventDefault();
          alert('Please select at least one error');
          return false;
        }

        // Add hidden inputs for each selected error ID
        checkedBoxes.forEach(checkbox => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'error_ids[]';
          input.value = checkbox.value;
          this.appendChild(input);
        });
      });
    }
  });
</script>
