# Lefthook Configuration for Rails Error Dashboard
# https://github.com/evilmartians/lefthook
# Version: 2.0.13+
#
# This ensures all code meets quality standards BEFORE pushing to CI,
# saving GitHub Actions minutes and providing faster feedback.
#
# Installation:
#   gem install lefthook
#   lefthook install
#
# Skip hooks temporarily:
#   LEFTHOOK=0 git commit -m "message"
#   git commit -m "message" --no-verify

# ============================================================================
# PRE-COMMIT (Fast checks - runs on git commit)
# ============================================================================
# These run ONLY on staged files for speed (< 2 seconds typically)
pre-commit:
  parallel: true

  commands:
    # RuboCop - Only on changed files (fast!)
    rubocop-changed:
      glob: "*.rb"
      run: bundle exec rubocop --force-exclusion {staged_files}
      stage_fixed: true  # Auto-stage fixes

    # Check for debugger statements
    no-debuggers:
      glob: "*.rb"
      run: |
        if git diff --cached --name-only | xargs grep -n -E "(binding\.pry|byebug|debugger|console\.log)" 2>/dev/null; then
          echo "‚ùå Found debugger statement! Remove before committing."
          exit 1
        fi

    # Check for Ruby syntax errors
    ruby-syntax:
      glob: "*.rb"
      run: ruby -c {staged_files}

    # Check for trailing whitespace
    trailing-whitespace:
      glob: "*.{rb,yml,md,js}"
      run: |
        if git diff --cached --name-only | xargs grep -n "[[:space:]]$" 2>/dev/null; then
          echo "‚ùå Found trailing whitespace! Run: git diff --cached | sed 's/[[:space:]]*$//' | git apply"
          exit 1
        fi

# ============================================================================
# PRE-PUSH (Comprehensive checks - mirrors CI)
# ============================================================================
# These run before git push to ensure CI will pass
pre-push:
  parallel: false  # Run sequentially for clear output

  commands:
    # 1. RuboCop - Full codebase check
    rubocop-full:
      run: bundle exec rubocop

    # 2. RSpec - Run full test suite
    rspec-full:
      run: |
        echo "üß™ Running full test suite (this may take a minute)..."
        COVERAGE=false bundle exec rspec

    # 3. Bundle audit - Check for vulnerable dependencies
    bundle-audit:
      run: |
        echo "üîí Checking for vulnerable dependencies..."
        gem install bundler-audit --conservative || true
        bundle audit check --update || echo "‚ö†Ô∏è  Warning: Bundle audit check failed, continuing..."

    # 4. Check for uncommitted changes
    check-uncommitted:
      run: |
        if [[ -n $(git status -s) ]]; then
          echo "‚ö†Ô∏è  Warning: You have uncommitted changes"
          git status -s
        fi

    # 5. Prevent force push to main
    no-force-push-main:
      run: |
        branch=$(git rev-parse --abbrev-ref HEAD)
        if [[ "$branch" == "main" ]] && git push --dry-run 2>&1 | grep -q "forced update"; then
          echo "‚ùå Force push to main is not allowed!"
          exit 1
        fi

# ============================================================================
# COMMIT-MSG (Validate commit messages)
# ============================================================================
commit-msg:
  commands:
    # Enforce conventional commits format (optional - commented out by default)
    # conventional-commits:
    #   run: |
    #     commit_msg=$(cat {1})
    #     if ! echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?: .+"; then
    #       echo "‚ùå Commit message must follow conventional commits format:"
    #       echo "   feat: add new feature"
    #       echo "   fix: resolve bug"
    #       echo "   docs: update documentation"
    #       exit 1
    #     fi

# ============================================================================
# CUSTOM COMMANDS (Run manually)
# ============================================================================
# Usage: lefthook run <command-name>

# Run all quality checks (like CI)
qa:
  parallel: false
  commands:
    rubocop:
      run: bundle exec rubocop
    rspec:
      run: COVERAGE=false bundle exec rspec
    bundle-audit:
      run: |
        gem install bundler-audit --conservative || true
        bundle audit check --update

# Quick check (fast subset)
quick:
  parallel: true
  commands:
    rubocop-changed:
      run: git diff --name-only main... | grep "\.rb$" | xargs bundle exec rubocop || true
    rspec-changed:
      run: |
        changed_specs=$(git diff --name-only main... | grep "_spec.rb$" || true)
        if [ -n "$changed_specs" ]; then
          COVERAGE=false bundle exec rspec $changed_specs
        else
          echo "No spec files changed"
        fi

# Fix auto-correctable RuboCop issues
fix:
  commands:
    rubocop-fix:
      run: bundle exec rubocop -A

# Multi-version testing (like CI)
multi-version:
  parallel: false
  commands:
    rails-7-0:
      run: RAILS_VERSION=7.0 bundle install && RAILS_VERSION=7.0 bundle exec rspec
    rails-7-1:
      run: RAILS_VERSION=7.1 bundle install && RAILS_VERSION=7.1 bundle exec rspec
    rails-7-2:
      run: RAILS_VERSION=7.2 bundle install && RAILS_VERSION=7.2 bundle exec rspec
    rails-8-0:
      run: RAILS_VERSION=8.0 bundle install && RAILS_VERSION=8.0 bundle exec rspec

# ============================================================================
# SKIP OPTIONS (for flexibility)
# ============================================================================
# Skip all hooks:           LEFTHOOK=0 git commit -m "message"
# Skip pre-commit:          LEFTHOOK_EXCLUDE=pre-commit git commit -m "message"
# Skip specific command:    LEFTHOOK_EXCLUDE=rubocop-full git push
# Skip verification:        git commit --no-verify -m "message"
#
# For CI/automated commits: set LEFTHOOK=0 environment variable
