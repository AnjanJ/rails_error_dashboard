# Lefthook Configuration for Rails Error Dashboard
# https://github.com/evilmartians/lefthook
#
# This runs quality checks on CHANGED files only for fast feedback.
#
# Installation:
#   gem install lefthook
#   lefthook install
#
# Skip hooks temporarily:
#   LEFTHOOK=0 git commit -m "message"
#   git commit -m "message" --no-verify

# ============================================================================
# PRE-COMMIT (Fast checks on changed files only)
# ============================================================================
pre-commit:
  parallel: true  # Run checks in parallel for speed

  commands:
    # 1. RuboCop - Only staged files
    rubocop-staged:
      glob: "*.rb"
      run: bundle exec rubocop {staged_files}

    # 2. RSpec - Only changed spec files
    rspec-changed:
      glob: "*_spec.rb"
      run: |
        if [ -n "{staged_files}" ]; then
          echo "üß™ Running tests for changed specs..."
          COVERAGE=false bundle exec rspec {staged_files}
        fi

    # 3. Bundle audit - Check for vulnerable dependencies
    bundle-audit:
      run: |
        echo "üîí Checking for vulnerable dependencies..."
        gem list bundler-audit -i > /dev/null || gem install bundler-audit --conservative
        bundle audit check --update

    # 4. Check for debugger statements in staged Ruby files
    no-debuggers:
      glob: "*.rb"
      run: |
        if echo "{staged_files}" | xargs grep -Hn "binding\.pry\|byebug\|debugger" 2>/dev/null; then
          echo "‚ùå Found debugger statement! Remove before committing."
          exit 1
        fi

    # 5. Check for trailing whitespace in staged files
    trailing-whitespace:
      glob: "*.{rb,yml,js,md}"
      run: |
        if echo "{staged_files}" | xargs grep -Hn "[[:space:]]$" 2>/dev/null; then
          echo "‚ùå Found trailing whitespace! Run: bundle exec rubocop -A"
          exit 1
        fi

# ============================================================================
# PRE-PUSH (Disabled - too slow and problematic)
# ============================================================================
# We rely on GitHub Actions CI instead of pre-push hooks

# ============================================================================
# COMMIT-MSG (Validate commit messages - optional)
# ============================================================================
# commit-msg:
#   commands:
#     conventional-commits:
#       run: |
#         commit_msg=$(cat {1})
#         if ! echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?: .+"; then
#           echo "‚ùå Commit message must follow conventional commits format"
#           exit 1
#         fi

# ============================================================================
# CUSTOM COMMANDS (Run manually with: lefthook run <command>)
# ============================================================================

# Run all quality checks like CI (comprehensive)
qa:
  parallel: false
  commands:
    rubocop:
      run: bundle exec rubocop
    rspec:
      run: bundle exec rspec
    bundle-audit:
      run: |
        gem list bundler-audit -i > /dev/null || gem install bundler-audit --conservative
        bundle audit check --update

# Quick check on changed files only (fast)
quick:
  parallel: true
  commands:
    rubocop-changed:
      run: |
        changed_files=$(git diff --name-only --diff-filter=AM HEAD | grep "\.rb$" || true)
        if [ -n "$changed_files" ]; then
          echo "$changed_files" | xargs bundle exec rubocop
        else
          echo "No Ruby files changed"
        fi
    rspec-changed:
      run: |
        changed_specs=$(git diff --name-only --diff-filter=AM HEAD | grep "_spec\.rb$" || true)
        if [ -n "$changed_specs" ]; then
          echo "üß™ Running changed specs..."
          COVERAGE=false bundle exec rspec $changed_specs
        else
          echo "No spec files changed"
        fi

# Fix auto-correctable RuboCop issues
fix:
  commands:
    rubocop-autofix:
      run: bundle exec rubocop -A

# Run full test suite (like CI)
full:
  parallel: false
  commands:
    rubocop:
      run: bundle exec rubocop
    rspec:
      run: bundle exec rspec
    audit:
      run: |
        gem list bundler-audit -i > /dev/null || gem install bundler-audit --conservative
        bundle audit check --update

# ============================================================================
# USAGE EXAMPLES
# ============================================================================
# Fast commit (only changed files):
#   git add . && git commit -m "message"
#
# Run full checks manually:
#   lefthook run qa
#   lefthook run full
#
# Quick check on current changes:
#   lefthook run quick
#
# Fix RuboCop issues:
#   lefthook run fix
#
# Skip hooks:
#   LEFTHOOK=0 git commit -m "message"
#   git commit --no-verify -m "message"
#
# Skip specific command:
#   LEFTHOOK_EXCLUDE=rspec-changed git commit -m "message"
