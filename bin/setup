#!/usr/bin/env bash
# Setup script for Rails Error Dashboard development
set -e

echo "ğŸš€ Setting up Rails Error Dashboard development environment..."
echo

# Check Ruby version
echo "ğŸ“ Checking Ruby version..."
ruby_version=$(ruby -v | awk '{print $2}')
required_version="3.2.0"
if [[ "$(printf '%s\n' "$required_version" "$ruby_version" | sort -V | head -n1)" != "$required_version" ]]; then
  echo "âŒ Ruby $required_version or higher is required"
  echo "   Current version: $ruby_version"
  exit 1
fi
echo "âœ… Ruby $ruby_version"
echo

# Install dependencies
echo "ğŸ“¦ Installing dependencies..."
bundle install
echo

# Install Lefthook hooks
echo "ğŸª Installing Lefthook git hooks..."
bundle exec lefthook install
echo "âœ… Git hooks installed (pre-commit, pre-push)"
echo

# Run bundle audit setup
echo "ğŸ”’ Setting up bundle audit..."
gem list bundler-audit | grep bundler-audit || gem install bundler-audit
bundle audit update
echo

# Setup database
echo "ğŸ—„ï¸  Setting up test database..."
RAILS_ENV=test bundle exec rails db:create db:migrate 2>/dev/null || echo "Database already exists"
echo

# Run tests to verify setup
echo "ğŸ§ª Running tests to verify setup..."
COVERAGE=false bundle exec rspec --format documentation --fail-fast || {
  echo "âŒ Some tests failed. Please fix before continuing."
  exit 1
}
echo

# Success!
echo "============================================"
echo "âœ… Setup complete!"
echo "============================================"
echo
echo "ğŸ“š Quick Reference:"
echo "  â€¢ Run tests:        bundle exec rspec"
echo "  â€¢ Run RuboCop:      bundle exec rubocop"
echo "  â€¢ Auto-fix RuboCop: bundle exec rubocop -A"
echo "  â€¢ Run all checks:   lefthook run qa"
echo "  â€¢ Run quick checks: lefthook run quick"
echo "  â€¢ Skip hooks:       LEFTHOOK=0 git commit"
echo
echo "ğŸª Git Hooks Active:"
echo "  â€¢ pre-commit: Fast checks on staged files"
echo "  â€¢ pre-push:   Full CI checks before pushing"
echo
echo "ğŸ’¡ Tip: Hooks save CI minutes by catching issues locally!"
echo
